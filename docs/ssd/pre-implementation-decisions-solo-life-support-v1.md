# 実装着手前の技術選定メモ: 一人暮らし支援アプリ v1

## 変更前整理（目的 / 影響範囲 / 検証方法）
- 目的: `task-solo-life-support-v1.md` の実装着手前チェックリストを埋めるために、技術選定・OCR費用上限・在庫推定方針を確定する。
- 影響範囲: `docs/ssd/` 配下の設計ドキュメントのみ（アプリ実装コードの変更なし）。
- 検証方法: 比較表に「採用理由 / 非採用理由 / 制約」が含まれていること、かつチェックリスト項目に対応した結論が明記されていることを目視確認する。

## 1) Web技術スタック候補比較と確定

### 1-1. フレームワーク
| 候補 | 採用可否 | 採用理由 / 非採用理由 | 制約 |
|---|---|---|---|
| Next.js 14 + TypeScript（App Router） | **採用** | SSR/CSRを同一基盤で使い分けやすく、将来の認証・API統合に拡張しやすい。フォームUIや集計画面の実装資産も多い。 | App Routerの学習コスト、Server/Client Componentの責務分離ルールをチームで統一する必要。 |
| Vite + React | 非採用 | 初期速度は速いが、将来SSRやRoute単位最適化を追加する際に構成増加の可能性がある。 | API/BFF層を別実装しやすく、現MVPでは過不足が出やすい。 |
| Nuxt 3 (Vue) | 非採用 | Vue基盤としては有力だが、現時点で想定実装資産がReact寄りで再利用性が下がる。 | UI部品・社内知見の置き換えコスト。 |

**確定**: Webフレームワークは **Next.js 14 + TypeScript** を採用する。

### 1-2. 状態管理
| 候補 | 採用可否 | 採用理由 / 非採用理由 | 制約 |
|---|---|---|---|
| Zustand + TanStack Query | **採用** | UIローカル状態（フォーム/モーダル）とサーバー状態（家計データ取得）を分離しやすく、MVPで過剰設計を避けられる。 | Store分割規約を最初に決めないと肥大化しやすい。 |
| Redux Toolkit | 非採用 | 大規模向けで堅牢だが、MVPの初期開発ではボイラープレートが増えやすい。 | 非同期処理方針を統一しないと記述が冗長化。 |
| Recoil | 非採用 | セレクタ設計は強力だが、今回の要件はサーバー状態中心で優先度が低い。 | 非同期キャッシュは別レイヤと組み合わせが必要。 |

**確定**: 状態管理は **Zustand + TanStack Query** を採用する。

### 1-3. DB / 永続化方式
| 候補 | 採用可否 | 採用理由 / 非採用理由 | 制約 |
|---|---|---|---|
| Supabase(PostgreSQL) + Prisma | **採用** | MVPで必要な永続化・認証拡張・バックアップ運用に対応しやすい。PostgreSQLの集計性能で月次レポート要件に適合。 | 無料枠超過時の課金管理、RLSやインデックス設計の初期整備が必要。 |
| Firestore | 非採用 | 速度は出しやすいが、複雑集計や月次比較クエリでコスト/クエリ設計が難化。 | ドキュメント設計次第で読み取り課金が増える。 |
| ブラウザLocalStorage/IndexedDB単体 | 非採用 | オフラインMVP用途では有効だが、端末跨ぎ利用や将来モバイル連携に弱い。 | データ移行・バックアップが利用者依存。 |

**確定**: 永続化は **Supabase(PostgreSQL) + Prisma** を採用する。

## 2) OCRプロバイダ候補比較と費用上限

### 2-1. 比較（精度・料金・API制約）
> 料金は2026-02時点の一般公開情報を基にした概算前提。実契約前に最新価格表で再確認する。

| 候補 | 精度評価（日本語レシート） | 料金目安（概算） | API制約 / 運用上の制約 | 採用判断 |
|---|---|---|---|---|
| Google Cloud Vision (Document Text Detection) | 高（日本語OCRの安定実績が多い） | おおむね **$1.5 / 1,000画像** 前後 | GCPプロジェクト管理・請求設定が必要。レシート構造化は自前整形が必要。 | **採用** |
| AWS Textract (DetectDocumentText/AnalyzeExpense) | 中〜高（構造抽出は強い） | Visionより高めになりやすい（API種別依存） | IAM設計やリージョン運用がやや重い。小規模MVPでは運用負荷が増える。 | 非採用 |
| Azure AI Vision / Form Recognizer | 中〜高 | 同等レンジだがSKU選定が複雑 | Azure運用基盤がないため初期セットアップコスト増。 | 非採用 |
| OCR.space 等の低価格API | 中（票種のばらつきに弱い） | 低コスト | レイテンシ/可用性/サポートの不確実性。 | 非採用 |

### 2-2. 上限コストの決定
- 想定利用: MVP初期は **月2,000レシート画像** を上限想定。
- 単価仮定: Google Cloud Vision を **$1.5 / 1,000画像** と仮置き。
- OCR直接費の想定: 約 **$3/月**（2,000画像時）。
- 安全係数（再試行・検証環境・変動吸収）: 8〜10倍を見込む。

**確定上限**: OCR関連ランニングコストは **月$30（約5,000円）** を上限とする。  
上限超過が2か月連続で発生した場合、(a)画像圧縮/前処理最適化、(b)OCR呼び出し回数抑制、(c)代替プロバイダ再評価を実施する。

## 3) 在庫推定ロジックの初期方針（ルールベース + 軽量推定）

### 3-1. 方針概要
- フェーズ1（MVP）では、説明可能性を優先し **ルールベース + 軽量推定** を採用する。
- ユーザーに表示する根拠は以下の3点で固定する。
  1. 最終購入日
  2. 推定消費間隔（日数）
  3. 推定在庫切れ日

### 3-2. 推定アルゴリズム（初期版）
1. 品目単位で購入履歴を時系列化する。
2. 連続購入間隔の中央値 `median_interval_days` を算出（データ不足時はカテゴリ既定値）。
3. `predicted_out_of_stock_date = last_purchase_date + median_interval_days` を計算。
4. 現在日との差分で優先度を算出。
   - 期限切れ（0日以下）: 高
   - 3日以内: 中
   - 7日以内: 低
5. 予算残高を加味し、カテゴリ予算超過見込みが高い候補は警告を付与する。

### 3-3. 軽量推定の補助ルール
- 購入履歴が3件未満の品目は、カテゴリ既定消費間隔を適用。
- 季節変動はMVPでは扱わない（将来拡張ポイントとして記録）。
- 提案候補は必ずユーザー編集可能とし、自動確定はしない。

### 3-4. 制約と今後の拡張条件
- 制約:
  - データ件数が少ない初期ユーザーでは精度が不安定。
  - 同一品目の表記ゆれ（例: 牛乳/ミルク）で履歴が分断される。
- 拡張条件:
  - 品目ごとに履歴10件以上が貯まった時点で、単純時系列モデル（指数平滑）を検証対象に追加する。

## 4) チェックリスト反映用の確定事項
- Web技術スタック: **Next.js 14 + TypeScript / Zustand + TanStack Query / Supabase(PostgreSQL) + Prisma**
- OCR: **Google Cloud Vision採用、月$30上限**
- 在庫推定: **ルールベース + 軽量推定（中央値間隔ベース）**

この文書を根拠として、`task-solo-life-support-v1.md` の「実装着手前チェックリスト」の該当3項目を完了扱いにする。
